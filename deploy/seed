#!/bin/bash
# seed — CLI tool for managing a seed agent
# Usage: seed <command> [options]

set -euo pipefail

SEED_HOME="${SEED_HOME:-$HOME/seed-agent}"
SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"

usage() {
    cat <<EOF
seed — Manage your seed agent

Usage: seed <command> [options]

Commands:
  init [--context NAME]    Initialize a new seed agent
  start                    Start the agent loop
  stop                     Stop the agent
  status                   Show agent status
  logs [--follow]          View agent logs
  connector <add|list>     Manage connectors

Environment:
  SEED_HOME    Agent home directory (default: ~/seed-agent)

EOF
    exit 0
}

cmd_init() {
    local CONTEXT=""
    while [[ $# -gt 0 ]]; do
        case $1 in
            --context) CONTEXT="$2"; shift 2 ;;
            *) echo "Unknown option: $1"; exit 1 ;;
        esac
    done

    echo "Initializing seed agent at $SEED_HOME..."

    if [ -n "$CONTEXT" ]; then
        bash "$SCRIPT_DIR/deploy/deploy.sh" --seed-home "$SEED_HOME" --context "$CONTEXT"
    else
        bash "$SCRIPT_DIR/deploy/deploy.sh" --seed-home "$SEED_HOME"
    fi
}

cmd_start() {
    if [ ! -f "$SEED_HOME/seed/loop.sh" ]; then
        echo "Error: No seed agent found at $SEED_HOME"
        echo "Run: seed init"
        exit 1
    fi

    # Check if already running
    if [ -f "$SEED_HOME/.pid" ]; then
        PID=$(cat "$SEED_HOME/.pid")
        if kill -0 "$PID" 2>/dev/null; then
            echo "Agent already running (pid=$PID)"
            exit 0
        fi
    fi

    echo "Starting seed agent..."
    cd "$SEED_HOME"
    SEED_HOME="$SEED_HOME" nohup bash seed/loop.sh > logs/loop-stdout.log 2>&1 &
    echo $! > "$SEED_HOME/.pid"
    echo "Agent started (pid=$!)"
    echo "Logs: tail -f $SEED_HOME/logs/loop.log"
}

cmd_stop() {
    if [ ! -f "$SEED_HOME/.pid" ]; then
        echo "No PID file found. Agent may not be running."
        exit 0
    fi

    PID=$(cat "$SEED_HOME/.pid")
    if kill -0 "$PID" 2>/dev/null; then
        echo "Stopping agent (pid=$PID)..."
        kill "$PID"
        rm -f "$SEED_HOME/.pid"
        echo "Agent stopped."
    else
        echo "Agent not running (stale PID file)."
        rm -f "$SEED_HOME/.pid"
    fi
}

cmd_status() {
    echo "=== Seed Agent Status ==="
    echo "Home: $SEED_HOME"
    echo ""

    # Running?
    if [ -f "$SEED_HOME/.pid" ]; then
        PID=$(cat "$SEED_HOME/.pid")
        if kill -0 "$PID" 2>/dev/null; then
            echo "Status: RUNNING (pid=$PID)"
        else
            echo "Status: STOPPED (stale PID)"
        fi
    else
        echo "Status: STOPPED"
    fi
    echo ""

    # Message counts
    INBOX_COUNT=$(find "$SEED_HOME/messages/inbox" -name '*.json' 2>/dev/null | wc -l)
    OUTBOX_COUNT=$(find "$SEED_HOME/messages/outbox" -name '*.json' 2>/dev/null | wc -l)
    echo "Inbox:  $INBOX_COUNT pending messages"
    echo "Outbox: $OUTBOX_COUNT pending messages"
    echo ""

    # Cycle count
    CYCLE_COUNT=$(find "$SEED_HOME/logs" -name 'cycle-*.log' 2>/dev/null | wc -l)
    echo "Cycles: $CYCLE_COUNT logged"

    # Last cycle
    LAST_CYCLE=$(find "$SEED_HOME/logs" -name 'cycle-*.log' -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -1 | cut -d' ' -f2-)
    if [ -n "$LAST_CYCLE" ]; then
        echo "Last:   $(basename "$LAST_CYCLE" .log)"
    fi
    echo ""

    # Memory files
    MEMORY_COUNT=$(find "$SEED_HOME/seed/memory" -name '*.md' 2>/dev/null | wc -l)
    echo "Memory: $MEMORY_COUNT files"

    # Connectors config
    if [ -f "$SEED_HOME/connectors.yml" ]; then
        CONN_COUNT=$(grep -c "^  - name:" "$SEED_HOME/connectors.yml" 2>/dev/null || echo 0)
        echo "Connectors: $CONN_COUNT configured"
    fi
}

cmd_logs() {
    local FOLLOW=false
    while [[ $# -gt 0 ]]; do
        case $1 in
            --follow|-f) FOLLOW=true; shift ;;
            *) echo "Unknown option: $1"; exit 1 ;;
        esac
    done

    LOG_FILE="$SEED_HOME/logs/loop.log"
    if [ ! -f "$LOG_FILE" ]; then
        echo "No logs found at $LOG_FILE"
        exit 1
    fi

    if $FOLLOW; then
        tail -f "$LOG_FILE"
    else
        tail -50 "$LOG_FILE"
    fi
}

cmd_connector() {
    local SUBCMD="${1:-}"
    shift || true

    case "$SUBCMD" in
        add)
            echo "Available connector types: cli, slack, discord, telegram, email, webhook"
            echo "Add to $SEED_HOME/connectors.yml manually or use a context template."
            ;;
        list)
            if [ -f "$SEED_HOME/connectors.yml" ]; then
                echo "Configured connectors:"
                grep "name:" "$SEED_HOME/connectors.yml" | sed 's/.*name: /  - /'
            else
                echo "No connectors.yml found at $SEED_HOME"
            fi
            ;;
        *)
            echo "Usage: seed connector <add|list>"
            ;;
    esac
}

# Main dispatch
COMMAND="${1:-}"
shift || true

case "$COMMAND" in
    init)      cmd_init "$@" ;;
    start)     cmd_start ;;
    stop)      cmd_stop ;;
    status)    cmd_status ;;
    logs)      cmd_logs "$@" ;;
    connector) cmd_connector "$@" ;;
    help|-h|--help|"") usage ;;
    *) echo "Unknown command: $COMMAND"; usage ;;
esac
